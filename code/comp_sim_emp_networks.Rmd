---
title: "Measure and compare network metrics from simulated community with empirical ones"
output: html_notebook
---




```{r}

library(ggplot2)

my.theme<-theme(axis.text=element_text(size=12),
                axis.title = element_text(size = 14),
                legend.position = "top",
                legend.text=element_text(size=10),
                legend.title = element_text(size=12),
                plot.title = element_text(face="bold",size=14,margin=margin(0,0,20,0),hjust = 0.5),
                axis.title.y = element_text(margin = margin(t = 0, r = 15, b = 0, l = 0)),
                axis.title.x = element_text(margin = margin(t = 15, r = 0, b = 0, l = 0)))
```




these metrics used in: https://www.nature.com/articles/s41598-019-54443-0


1. Number of species within the foodweb (S)
2. liks density (L/S)
3. directed connectance (C = L/S2)
4. %T (Top species that have resource species but lack any consumer species)
5. % I (Intermediate species that have both resource and consumer species)
6. % B (Basal species that have consumer species but lack resources species)
7. %C (Cannibal species that eat themselves)
8. %Omn (species that eat species at different trophic levels)
9. Standard deviation of mean generality (GenSD)
10. Standard deviation of mean vulnerability (VulSD)


Reference page: https://rfrelat.github.io/BalticFoodWeb.html


```{r}
library(fluxweb)
library(NetIndices)
library(ggplot2)
library(reshape2)
library(data.table)
library(purrr)
library(here)
library(igraph)
library(stringr)
library(ggpubr)


source("functions/functions_metrics_networks.R")
source("functions/functions_phylo_signal.R")

```


# Compare metrics between scenarios to choose the best one

## Neutral

### Get data paths

```{r}


# Make a vector of all your file paths

file_paths_n <- list.files(path = here::here("data/neutral/"), pattern = ".rds", full.names = TRUE)


# Make a vector of file names
file_names_n <-  gsub(pattern = ".rds$", replacement = "", x = basename(file_paths_n))



```



### Compute network metrics

Get the adjacency matrix of each simulation and compute the network metrics

```{r}

# Get adjacency matrix from each simulation object stored in our folder
         
adj_matrix_list_n <-  get_adjancency_from_simulation.objects(file_path = file_paths_n)


# Compute network metrics

net_metr_n.sim <- get_network_measures_from_adjacency(list_adj_matrix = adj_matrix_list_n)

net_metr_n.sim$simulation <- NULL






```


Identify each scenario

```{r}


## Idenfity what scenario belongs to each simulation by the file names

scenarios <- c()

for (i in 1:length(file_paths_n)) {
  
  list_files <- readRDS(file_paths_n[[i]])
  
  scenarios[i] <- list_files$scenario
  
  
  
}

df <- data.frame(file_paths_n, scenarios)

df$file_names <- file_names_n


# parameters of scenarios -> DONT REALLY NEED IT - I CAN CHECK AFTER


#neutral_df_scenarios_success <- readRDS(file = "neutral_df_scenarios_success.rds")

#neutral_df_scenarios_success$scenarios <- rownames(neutral_df_scenarios_success)


for (i in 1:length(net_metr_n.sim$sc)) {
  
  net_metr_n.sim$sc[i] <- df$scenarios[which(df[,"file_names"] == net_metr_n.sim[i,"sc"])]
  
}



```


Calculate means of simulations per scenario


```{r}


net_metr_n.mean.sc <- aggregate(net_metr_n.sim[, 1:ncol(net_metr_n.sim)], list(net_metr_n.sim$sc), mean)

colnames(net_metr_n.mean.sc)[1] <- "scenario"

net_metr_n.mean.sc

```


### Compute Motifs

```{r}
motifs_n_sim <- compute_motifs_from_adjacency(adj_matrix_list_n)

motifs_n_sim
```

















# Once scenarios are chosen, compare with empirical 



## Metrics from empirical networks

see:
https://mlurgi.github.io/networks_for_r/lesson-4.html


```{r}
# Make a vector of all your file paths

file_paths_emp <- list.files(path = here::here("C:/Users/alexf/Desktop/empirical_foodwebs/csv/"), pattern = ".csv", full.names = TRUE)

```


```{r}

list_files <- list()

for(i in 1:length(file_paths_emp)) {                              # Head of for-loop
 list_files[[i]] <- read.csv(file_paths_emp[i], sep = ",", row.names = 1)
 
 list_files[[i]][list_files[[i]] > 0] <- 1
 
 
 list_files[[i]] <- as.matrix(list_files[[i]])
 
 class(list_files[[i]]) <- "numeric"
 
}



references <- read.csv("C:/Users/alexf/Desktop/empirical_foodwebs/references.csv")


```


The number of species in columns and rows differs slightly for most of the foodwebs - I subset only for those species present in both the rows and columns.

Spp names are separated by space in the rows and by point in columns. I therefore homogenize them (with space) to be able to subset later

```{r}


list_files_names.checked <- list()

for (i in 1:length(list_files)) {
  
  colnames(list_files[[i]]) <- gsub("[.]", " ", colnames(list_files[[i]]))
  
  common_spp <- intersect(colnames(list_files[[i]]), rownames(list_files[[i]]))
  
  list_files_names.checked[[i]] <- list_files[[i]][common_spp,common_spp]
}


references

```



```{r}



net_metr_empirical <- get_network_measures_from_adjacency(list_adj_matrix =  list_files_names.checked)

net_metr_empirical[,"id"] <- references$ID

net_metr_empirical

#saveRDS(net_metr_empirical, "../data/net_metrics_empirical.rds")
#net_metr_empirical <- readRDS("../data/net_metrics_empirical.rds")

```

```{r}
net_metr_empirical$id <- NULL

net_metr_empirical <- net_metr_empirical[-13,]

df_metrics_emp <- reshape_df_net.metrics(df_metrics = net_metr_empirical,
                       interaction = "empirical")

df_metrics_emp

```



Vector of frequencies of triad isomorphic classes

```{r}

motifs_empirical <- compute_motifs_from_adjacency(list_adj_matrix = list_files_names.checked)

colnames(motifs_empirical[[1]])

motifs_empirical$scenario <- NULL

motifs_empirical_mean <- data.frame(names(colMeans(motifs_empirical[[1]])),colMeans(motifs_empirical[[1]]))

options(scipen = 999)

df_motif_empirical <- reshape_df_motifs(df_motifs = motifs_empirical[[1]], interaction = "empirical")

options(scipen = 0)

df_motif_empirical

```



## Metrics from simulations



### Get data paths


Facilitation, competition, foodweb

```{r}



# Make a vector of all your file paths

file_paths_fac <- list.files(path = here::here("data/selection_evolution/facilitation/"), pattern = ".rds", full.names = TRUE)

file_paths_comp <- list.files(path = here::here("data/selection_evolution/competition/"), pattern = ".rds", full.names = TRUE)

file_paths_fw <- list.files(path = here::here("data/selection_evolution/foodweb/"), pattern = ".rds", full.names = TRUE)

file_paths_fw1 <- list.files(path = here::here("data/selection_evolution/foodweb1/"), pattern = ".rds", full.names = TRUE)

file_paths_n <- list.files(path = here::here("data/neutral/sims/"), pattern = ".rds", full.names = TRUE)




# Make a vector of file names
file_names_fac <-  gsub(pattern = ".rds$", replacement = "", x = basename(file_paths_fac))

file_names_comp <-  gsub(pattern = ".rds$", replacement = "", x = basename(file_paths_comp))

file_names_fw <-  gsub(pattern = ".rds$", replacement = "", x = basename(file_paths_fw))

file_names_fw1 <-  gsub(pattern = ".rds$", replacement = "", x = basename(file_paths_fw1))

file_names_n <-  gsub(pattern = ".rds$", replacement = "", x = basename(file_paths_n))


```



### Compute network metrics

Get the adjacency matrix of each simulation and compute the network metrics

```{r}

# Get adjacency matrix from each simulation object stored in our folder
         
adj_matrix_list_fac <-  get_adjancency_from_simulation.objects(file_path = file_paths_fac)

adj_matrix_list_comp <-  get_adjancency_from_simulation.objects(file_path = file_paths_comp)

adj_matrix_list_fw <-  get_adjancency_from_simulation.objects(file_path = file_paths_fw)

adj_matrix_list_fw1 <-  get_adjancency_from_simulation.objects(file_path = file_paths_fw1)

adj_matrix_list_n <-  get_adjancency_from_simulation.objects(file_path = file_paths_n)


# Compute network metrics

net_metr_fac.sim <- get_network_measures_from_adjacency(list_adj_matrix = adj_matrix_list_fac)

net_metr_comp.sim <- get_network_measures_from_adjacency(list_adj_matrix = adj_matrix_list_comp)

net_metr_fw.sim <- get_network_measures_from_adjacency(list_adj_matrix = adj_matrix_list_fw)

net_metr_fw.sim1 <- get_network_measures_from_adjacency(list_adj_matrix = adj_matrix_list_fw1)

net_metr_n.sim <- get_network_measures_from_adjacency(list_adj_matrix = adj_matrix_list_n)



list_files <- readRDS(file_paths_fw1[[3]])

net <- list_files$network_list[[length(list_files$network_list)]]

mat_b_col <- matrix(0,1025,25)

net1 <- cbind(mat_b_col, net)

net_numbers <- set_sppNames_numbers(net1)

net_letters <- convert_sppnames_toletters(net_numbers)


 ## Crop network for present spp
    
    
    colnames(list_files$presence_matrix) <- seq(1:1000)
    
    colnames(list_files$presence_matrix) <- as.character(as.numeric(colnames(list_files$presence_matrix)) + 
                                                           rep(25, times = ncol(list_files$presence_matrix)))
        
    colnames(list_files$presence_matrix) <- chartr("0123456789", "ABCDEFGHIJ", colnames(list_files$presence_matrix))
    
    list_files$presence_matrix <- list_files$presence_matrix[length(list_files$network_list),]
    
    
vec_names_rows <- c(rownames(net_letters[1:25, ]), names(which(list_files$presence_matrix == 1))) 

vec_names_cols <- c(colnames(net_letters[,1:25]), names(which(list_files$presence_matrix == 1)))

    
adj_matrix <- net_letters[names(which(list_files$presence_matrix == 1)),names(which(list_files$presence_matrix == 1))]

adj_matrix <- net_letters[vec_names_rows, vec_names_cols]

cbind(net_letters[,1:25], adj_matrix)

## check spp diversity over time

n_spp_timestep <- c()

for(i in 1:nrow(list_files$presence_matrix)){
  
  n_spp_timestep[i] <- length(which(list_files$presence_matrix[i,] == 1))
  
}

timesteps <- c(1:length(n_spp_timestep))

plot(timesteps, n_spp_timestep)


list_files$traits_df

plot(list_files$traits_df[,1], list_files$traits_df[,3])
```




Compute table with mean metrics

```{r}



df_metrics_fac <- reshape_df_net.metrics(df_metrics = net_metr_fac.sim,
                       interaction = "facilitation")

df_metrics_comp <- reshape_df_net.metrics(df_metrics = net_metr_comp.sim,
                       interaction = "competition")


df_metrics_fw <- reshape_df_net.metrics(df_metrics = net_metr_fw.sim,
                       interaction = "foodweb")

df_metrics_fw1 <- reshape_df_net.metrics(df_metrics = net_metr_fw.sim1,
                       interaction = "foodweb")

df_metrics_n <- reshape_df_net.metrics(df_metrics = net_metr_n.sim,
                       interaction = "neutral")


df_metrics_comp$id  <- 1:nrow(df_metrics_comp)

df_metrics <- merge(df_metrics_fac, 
      df_metrics_comp,
      by = "metric")

df_metrics <- merge(df_metrics,
                    df_metrics_fw,
                    by = "metric")

df_metrics <- merge(df_metrics,
                    df_metrics_fw1,
                    by = "metric")

df_metrics <- merge(df_metrics,
                    df_metrics_n,
                    by = "metric")

# Joining the empirical networks here

df_metrics <- merge(df_metrics,
                    df_metrics_emp,
                    by = "metric")

df_metrics <- df_metrics[order(df_metrics$id), ]

rownames(df_metrics) <- NULL

df_metrics$id <- NULL

df_metrics

#saveRDS(df_metrics, "../data/net_metrics_all.rds")
#df_metrics <- readRDS("../data/net_metrics_all.rds")

```

Plot the results

```{r}



p_S <- plot_metric(metric = "S", y_axis = "N species")

p_link.dens <- plot_metric(metric = "Link_density", y_axis = "L/S")

p_C <- plot_metric(metric = "C", y_axis = "Connectance")

p_top <- plot_metric(metric = "perc_tops", y_axis = "% top species")

p_int <- plot_metric(metric = "perc_int", y_axis = "% intermediate species")

p_basal <- plot_metric(metric = "perc_basals", y_axis = "% basal species")

p_cannibals <- plot_metric(metric = "perc_cannibals", y_axis = "% cannibal species")

p_omnivory <- plot_metric(metric = "omnivory", y_axis = "omnivory")

p_sd_gen <- plot_metric(metric = "sd_gen", y_axis = "SD generality")

p_sd_vul <- plot_metric(metric = "sd_vul", y_axis = "SD vulnerability")


plot_metrics_comparison_sim_emp <- ggarrange(
  
  p_S,
  p_link.dens,
  p_C,
  p_top,
  p_int,
  p_basal,
  p_cannibals,
  p_omnivory,
  p_sd_gen,
  p_sd_vul,
  
  nrow = 5,
  ncol = 2
  
)


#ggsave("../figures/plot_metrics_comparison_sim_emp.png", height = 15, width = 12)

```




### Compute Motifs

Vector of frequencies of triad isomorphic classes

```{r}

motifs_fac_sim <- compute_motifs_from_adjacency(adj_matrix_list_fac)

motifs_comp_sim <- compute_motifs_from_adjacency(adj_matrix_list_comp)

motifs_fw_sim <- compute_motifs_from_adjacency(adj_matrix_list_fw)

```

```{r}



df_mean_motifs_fac <- reshape_df_motifs(motifs_fac_sim[[1]], interaction = "facilitation")

df_mean_motifs_comp <- reshape_df_motifs(motifs_comp_sim[[1]], interaction = "competition")

df_mean_motifs_fw <- reshape_df_motifs(motifs_fw_sim[[1]], interaction = "foodweb")




df_mean_motifs_comp$id  <- 1:nrow(df_mean_motifs_comp)

df_motifs <- merge(df_mean_motifs_fac, 
      df_mean_motifs_comp,
      by = "motif")

df_motifs <- merge(df_motifs, df_mean_motifs_fw,
                   by = "motif")

df_motifs <- df_motifs[order(df_motifs$id), ]

rownames(df_motifs) <- NULL

df_motifs$id <- NULL

df_motifs


```


plot motif means of each interaction type

```{r}


df_melted = melt(df_motifs, id.vars = 'motif')


ggplot(df_melted, aes(x = motif, y = value)) + geom_line(aes(color = variable, group = variable))+
    theme_bw()+
    my.theme+
    theme(legend.position = "right")+
    xlab("triad isomorphism classes")+
    ylab("frequency")


ggplot(df_melted, aes(x = motif, y = value)) + 
  geom_point(aes(color = variable, group = variable, size = 4, alpha = 0.7))+
    theme_bw()+
    my.theme+
    theme(legend.position = "right")+
    xlab("triad isomorphism classes")+
    ylab("frequency")

```
















