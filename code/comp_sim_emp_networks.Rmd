---
title: "Measure and compare network metrics from simulated community with empirical ones"
output: html_notebook
---




```{r}

library(ggplot2)

my.theme<-theme(axis.text=element_text(size=12),
                axis.title = element_text(size = 14),
                legend.position = "top",
                legend.text=element_text(size=10),
                legend.title = element_text(size=12),
                plot.title = element_text(face="bold",size=14,margin=margin(0,0,20,0),hjust = 0.5),
                axis.title.y = element_text(margin = margin(t = 0, r = 15, b = 0, l = 0)),
                axis.title.x = element_text(margin = margin(t = 15, r = 0, b = 0, l = 0)))
```




these metrics used in: https://www.nature.com/articles/s41598-019-54443-0


1. Number of species within the foodweb (S)
2. liks density (L/S)
3. directed connectance (C = L/S2)
4. %T (Top species that have resource species but lack any consumer species)
5. % I (Intermediate species that have both resource and consumer species)
6. % B (Basal species that have consumer species but lack resources species)
7. %C (Cannibal species that eat themselves)
8. %Omn (species that eat species at different trophic levels)
9. Standard deviation of mean generality (GenSD)
10. Standard deviation of mean vulnerability (VulSD)


Reference page: https://rfrelat.github.io/BalticFoodWeb.html


```{r}
library(fluxweb)
library(NetIndices)
library(ggplot2)
library(reshape2)
library(data.table)
library(purrr)
library(here)
library(igraph)
library(stringr)


source("functions/functions_metrics_networks.R")
source("functions/functions_phylo_signal.R")

```


# Compare metrics between scenarios to choose the best one

## Neutral

### Get data paths

```{r}


# Make a vector of all your file paths

file_paths_n <- list.files(path = here::here("data/neutral/"), pattern = ".rds", full.names = TRUE)


# Make a vector of file names
file_names_n <-  gsub(pattern = ".rds$", replacement = "", x = basename(file_paths_n))



```



### Compute network metrics

Get the adjacency matrix of each simulation and compute the network metrics

```{r}

# Get adjacency matrix from each simulation object stored in our folder
         
adj_matrix_list_n <-  get_adjancency_from_simulation.objects(file_path = file_paths_n)


# Compute network metrics

net_metr_n.sim <- get_network_measures_from_adjacency(list_adj_matrix = adj_matrix_list_n)

net_metr_n.sim$simulation <- NULL






```


Identify each scenario

```{r}


## Idenfity what scenario belongs to each simulation by the file names

scenarios <- c()

for (i in 1:length(file_paths_n)) {
  
  list_files <- readRDS(file_paths_n[[i]])
  
  scenarios[i] <- list_files$scenario
  
  
  
}

df <- data.frame(file_paths_n, scenarios)

df$file_names <- file_names_n


# parameters of scenarios -> DONT REALLY NEED IT - I CAN CHECK AFTER


#neutral_df_scenarios_success <- readRDS(file = "neutral_df_scenarios_success.rds")

#neutral_df_scenarios_success$scenarios <- rownames(neutral_df_scenarios_success)


for (i in 1:length(net_metr_n.sim$sc)) {
  
  net_metr_n.sim$sc[i] <- df$scenarios[which(df[,"file_names"] == net_metr_n.sim[i,"sc"])]
  
}



```


Calculate means of simulations per scenario


```{r}


net_metr_n.mean.sc <- aggregate(net_metr_n.sim[, 1:ncol(net_metr_n.sim)], list(net_metr_n.sim$sc), mean)

colnames(net_metr_n.mean.sc)[1] <- "scenario"

net_metr_n.mean.sc

```


### Compute Motifs

```{r}
motifs_n_sim <- compute_motifs_from_adjacency(adj_matrix_list_n)

motifs_n_sim
```

















# Once scenarios are chosen, compare with empirical 



## Metrics from empirical networks

see:
https://mlurgi.github.io/networks_for_r/lesson-4.html


```{r}
# Make a vector of all your file paths

file_paths_emp <- list.files(path = here::here("C:/Users/alexf/Desktop/empirical_foodwebs/csv/"), pattern = ".csv", full.names = TRUE)

```


```{r}

list_files <- list()

for(i in 1:length(file_paths_emp)) {                              # Head of for-loop
 list_files[[i]] <- read.csv(file_paths_emp[i], sep = ",", row.names = 1)
 
 list_files[[i]][list_files[[i]] > 0] <- 1
 
 
 list_files[[i]] <- as.matrix(list_files[[i]])
 
 class(list_files[[i]]) <- "numeric"
 
}



references <- read.csv("C:/Users/alexf/Desktop/empirical_foodwebs/references.csv")


```


The number of species in columns and rows differs slightly for most of the foodwebs - I subset only for those species present in both the rows and columns.

Spp names are separated by space in the rows and by point in columns. I therefore homogenize them (with space) to be able to subset later

```{r}


list_files_names.checked <- list()

for (i in 1:length(list_files)) {
  
  colnames(list_files[[i]]) <- gsub("[.]", " ", colnames(list_files[[i]]))
  
  common_spp <- intersect(colnames(list_files[[i]]), rownames(list_files[[i]]))
  
  list_files_names.checked[[i]] <- list_files[[i]][common_spp,common_spp]
}


references

```



```{r}



net_metr_empirical <- get_network_measures_from_adjacency(list_adj_matrix =  list_files_names.checked)

net_metr_empirical[,"id"] <- references$ID

net_metr_empirical

#saveRDS(net_metr_empirical, "../data/net_metrics_empirical.rds")
#net_metr_empirical <- readRDS("../data/net_metrics_empirical.rds")

```

```{r}
net_metr_empirical$id <- NULL

net_metr_empirical <- net_metr_empirical[-13,]

df_metrics_emp <- reshape_df_net.metrics(df_metrics = net_metr_empirical,
                       interaction = "empirical")

df_metrics_emp

```



Vector of frequencies of triad isomorphic classes

```{r}

motifs_empirical <- compute_motifs_from_adjacency(list_adj_matrix = list_files_names.checked)

colnames(motifs_empirical[[1]])

motifs_empirical$scenario <- NULL

motifs_empirical_mean <- data.frame(names(colMeans(motifs_empirical[[1]])),colMeans(motifs_empirical[[1]]))

options(scipen = 999)

df_motif_empirical <- reshape_df_motifs(df_motifs = motifs_empirical[[1]], interaction = "empirical")

options(scipen = 0)

df_motif_empirical

```



## Metrics from simulations



### Get data paths


Facilitation, competition, foodweb

```{r}



# Make a vector of all your file paths

file_paths_fac <- list.files(path = here::here("data/selection_evolution/facilitation/"), pattern = ".rds", full.names = TRUE)

file_paths_comp <- list.files(path = here::here("data/selection_evolution/competition/"), pattern = ".rds", full.names = TRUE)

file_paths_fw <- list.files(path = here::here("data/selection_evolution/foodweb/"), pattern = ".rds", full.names = TRUE)

file_paths_n <- list.files(path = here::here("data/neutral/sims/"), pattern = ".rds", full.names = TRUE)




# Make a vector of file names
file_names_fac <-  gsub(pattern = ".rds$", replacement = "", x = basename(file_paths_fac))

file_names_comp <-  gsub(pattern = ".rds$", replacement = "", x = basename(file_paths_comp))

file_names_fw <-  gsub(pattern = ".rds$", replacement = "", x = basename(file_paths_fw))

file_names_n <-  gsub(pattern = ".rds$", replacement = "", x = basename(file_paths_n))


```



### Compute network metrics

Get the adjacency matrix of each simulation and compute the network metrics

```{r}

# Get adjacency matrix from each simulation object stored in our folder
         
adj_matrix_list_fac <-  get_adjancency_from_simulation.objects(file_path = file_paths_fac)

adj_matrix_list_comp <-  get_adjancency_from_simulation.objects(file_path = file_paths_comp)

adj_matrix_list_fw <-  get_adjancency_from_simulation.objects(file_path = file_paths_fw)

adj_matrix_list_n <-  get_adjancency_from_simulation.objects(file_path = file_paths_n)


# Compute network metrics

net_metr_fac.sim <- get_network_measures_from_adjacency(list_adj_matrix = adj_matrix_list_fac)

net_metr_comp.sim <- get_network_measures_from_adjacency(list_adj_matrix = adj_matrix_list_comp)

net_metr_fw.sim <- get_network_measures_from_adjacency(list_adj_matrix = adj_matrix_list_fw)

net_metr_n.sim <- get_network_measures_from_adjacency(list_adj_matrix = adj_matrix_list_n)

```




Compute table with mean metrics

```{r}



df_metrics_fac <- reshape_df_net.metrics(df_metrics = net_metr_fac.sim,
                       interaction = "facilitation")

df_metrics_comp <- reshape_df_net.metrics(df_metrics = net_metr_comp.sim,
                       interaction = "competition")


df_metrics_fw <- reshape_df_net.metrics(df_metrics = net_metr_fw.sim,
                       interaction = "foodweb")

df_metrics_n <- reshape_df_net.metrics(df_metrics = net_metr_n.sim,
                       interaction = "neutral")


df_metrics_comp$id  <- 1:nrow(df_metrics_comp)

df_metrics <- merge(df_metrics_fac, 
      df_metrics_comp,
      by = "metric")

df_metrics <- merge(df_metrics,
                    df_metrics_fw,
                    by = "metric")

df_metrics <- merge(df_metrics,
                    df_metrics_n,
                    by = "metric")

# Joining the empirical networks here

df_metrics <- merge(df_metrics,
                    df_metrics_emp,
                    by = "metric")

df_metrics <- df_metrics[order(df_metrics$id), ]

rownames(df_metrics) <- NULL

df_metrics$id <- NULL

df_metrics

#saveRDS(df_metrics, "../data/net_metrics_all.rds")
#df_metrics <- readRDS("../data/net_metrics_all.rds")

```

Plot the results

```{r}

# S

df_S <- df_metrics[df_metrics$metric == "S",]

df_S_plot <- df_S[,c("metric","facilitation", "competition", "foodweb", "neutral", "empirical")]

df_S_se <- df_S[1,c("metric","se_ facilitation", "se_ competition", "se_ foodweb", "se_ neutral", "se_ empirical")]



df_S_plot <- melt(df_S_plot, id = "metric")

df_S_se_plot <- melt(df_S_se, id = "metric")

colnames(df_S_se_plot)[colnames(df_S_se_plot) == "value"] <- "se"

df_S_plot$se <- df_S_se_plot$se

ggplot(df_S_plot) +
  geom_bar( aes(x=variable, y=value, fill = variable), stat="identity", position = position_dodge(width = 0.2)) +
 geom_errorbar( aes(x=variable, ymin=value-se, ymax=value+se), width=0.1, alpha=0.9, size=1) +
  ggtitle("metric: S")+
  scale_fill_manual(values = c("gray50", "gray50", "gray50", "gray50", "gray82"))+
  xlab("")+
  ylab("N species")+
  theme_bw()+
  my.theme+
    theme(legend.position = "none")

```




### Compute Motifs

Vector of frequencies of triad isomorphic classes

```{r}

motifs_fac_sim <- compute_motifs_from_adjacency(adj_matrix_list_fac)

motifs_comp_sim <- compute_motifs_from_adjacency(adj_matrix_list_comp)

motifs_fw_sim <- compute_motifs_from_adjacency(adj_matrix_list_fw)

```

```{r}



df_mean_motifs_fac <- reshape_df_motifs(motifs_fac_sim[[1]], interaction = "facilitation")

df_mean_motifs_comp <- reshape_df_motifs(motifs_comp_sim[[1]], interaction = "competition")

df_mean_motifs_fw <- reshape_df_motifs(motifs_fw_sim[[1]], interaction = "foodweb")




df_mean_motifs_comp$id  <- 1:nrow(df_mean_motifs_comp)

df_motifs <- merge(df_mean_motifs_fac, 
      df_mean_motifs_comp,
      by = "motif")

df_motifs <- merge(df_motifs, df_mean_motifs_fw,
                   by = "motif")

df_motifs <- df_motifs[order(df_motifs$id), ]

rownames(df_motifs) <- NULL

df_motifs$id <- NULL

df_motifs


```


plot motif means of each interaction type

```{r}


df_melted = melt(df_motifs, id.vars = 'motif')


ggplot(df_melted, aes(x = motif, y = value)) + geom_line(aes(color = variable, group = variable))+
    theme_bw()+
    my.theme+
    theme(legend.position = "right")+
    xlab("triad isomorphism classes")+
    ylab("frequency")


ggplot(df_melted, aes(x = motif, y = value)) + 
  geom_point(aes(color = variable, group = variable, size = 4, alpha = 0.7))+
    theme_bw()+
    my.theme+
    theme(legend.position = "right")+
    xlab("triad isomorphism classes")+
    ylab("frequency")

```
















