---
title: "FOODWEB"
output: html_notebook
---




```{r}
#source("../Original_code/functions/tree_functions.R")
#source("../Original_code/functions/phylo_functions.R")
source("../AF_code/AF_functions_tree.R")
library(ape)
library(apTreeshape)

library("vegan")
```


### Load simulation data


```{r}

load("../AF_Data/Positive_interactions/foodwebTest2.Rdata")

names(list_res) = c("simulation1", "simulation2")

list_simulation1 <- list_res$simulation1


# List for table ancestry-distances and networks
# The first element of both is NULL, so we eliminated it

list_anc_dist <- list_simulation1$list_anc_dist[-1]
network_list <- list_simulation1$network_list[-1]

length(list_anc_dist) == length(network_list)
```








## Convert spp names from numbers to letters

```{r}

## Ancestry-distance

list_anc_dist_letters <- lapply(list_anc_dist, change_sppnames_letters_ancdist.table)


## Interactions

#### 1st, set names as numbers (index of columns and rows)

# WARING - Eliminating first timestep

list_networks_sppnames_numbers <- lapply(network_list, set_sppNames_numbers)

#### 2nd, convert numbers to letters

list_networks_sppnames_letters <- lapply(list_networks_sppnames_numbers, convert_sppnames_toletters)



length(list_anc_dist_letters) == length(list_networks_sppnames_letters)
```




#### Loop for obtaining phylogenetic distances:


Distances can only be calculated from the 3rd matrix in advance, because there is no more than two species until then. So the first two matrix are NULL and we will eliminate them.

We eliminated timestep 1 at the beggining of the code. Eliminating now the 1st (timestep2) and 2nd (timestep3) matrices means that we retain from timestp 4 in advance.

```{r}

list_newick <- list()
list_trees <- list()
list_newick_tails <- list()
list_dist.phylo <- list()


## Can't calculate distances with only 1 spp, so I need to start from the 3rd matrix, so timestep 4

for (i in 3:length(list_anc_dist_letters)) {
  
  
  print(sprintf("step %s", i))
  
  list_newick[[i]] <- ToPhylo(list_anc_dist_letters[[i]])
  
  list_newick_tails[[i]] <- paste(list_newick[[i]], "root")
  
  list_trees[[i]] <- read.tree(text = sub("A root",";",list_newick_tails[[i]]))
  
  list_dist.phylo[[i]] <- cophenetic.phylo(list_trees[[i]])
  

}


# Eliminate first two matrices (timestep 2 and 3) that are NULL

list_dist.phylo <- list_dist.phylo[-c(1,2)]


length(list_dist.phylo) # 182

```



#### Interaction distances

We eliminate the 1st and 2nd matrix (timestep 2 and 3) as we did for the list of phylogenetic distance matrices so that we can compare the lists later.

```{r}

list_networks_sppnames_letters <- list_networks_sppnames_letters[-c(1,2)]

length(list_networks_sppnames_letters) # 180

```




##### FOR PREDATORS 

```{r}
# Compute distances

list_dist_chisq_pred <- list()

for (i in 1:length(list_networks_sppnames_letters)) {
  
  list_dist_chisq_pred[[i]] <- compute_chisq_pred(matrix = list_networks_sppnames_letters[[i]],
                                                  distance = "chisq")
  
}



length(list_dist_chisq_pred)
```


##### FOR PREYS 

```{r}
# Compute distances

list_dist_chisq_prey <- list()

for (i in 1:length(list_networks_sppnames_letters)) {
  
  list_dist_chisq_prey[[i]] <- compute_chisq_prey(matrix = list_networks_sppnames_letters[[i]],
                                                  distance = "chisq")
  
}



length(list_dist_chisq_prey)
```

check length list phylo_dist == length list interact_dist

```{r}

length(list_dist_chisq_pred) == length(list_dist.phylo)
length(list_dist_chisq_prey) == length(list_dist.phylo)
```
## Order column and row spp names


```{r}
list_dist.phylo_df <- lapply(list_dist.phylo, as.data.frame)

list_dist_chisq_pred_df <- lapply(list_dist_chisq_pred, as.data.frame)
list_dist_chisq_prey_df <- lapply(list_dist_chisq_prey, as.data.frame)




list_dist.phylo_df.ord <- lapply(list_dist.phylo_df, order_col.row_names)

list_dist_chisq_pred_df.ord <- lapply(list_dist_chisq_pred_df, order_col.row_names)
list_dist_chisq_prey_df.ord <- lapply(list_dist_chisq_prey_df, order_col.row_names)

```


## For phylogenetic distance matrices, retain only those species present


Here I need to do it for predators and preys separatelly, since they will act as preys or predators and some of them may not be one of them.

Species present are those present in the interaction distance matrix.

## For predators

```{r}
# Select only spp present for phylogenetic distance matrix

list_dist.phylo_df_pres_pred <- list()

for (i in 1:length(list_dist.phylo_df.ord)) {
  
  spp_present <- colnames(list_dist_chisq_pred_df.ord[[i]])
  list_dist.phylo_df_pres_pred[[i]] <- list_dist.phylo_df.ord[[i]][spp_present ,spp_present] 
  
  
}

## Check that now phylo and interaction distance matrices have the same number of spp, same names, and in the same order


colnames(list_dist.phylo_df_pres_pred[[100]]) == colnames(list_dist_chisq_pred_df.ord[[100]])
```

## For preys

```{r}
# Select only spp present for phylogenetic distance matrix

list_dist.phylo_df_pres_prey <- list()

for (i in 1:length(list_dist.phylo_df.ord)) {
  
  spp_present <- colnames(list_dist_chisq_prey_df.ord[[i]])
  list_dist.phylo_df_pres_prey[[i]] <- list_dist.phylo_df.ord[[i]][spp_present ,spp_present] 
  
  
}

## Check that now phylo and interaction distance matrices have the same number of spp, same names, and in the same order


colnames(list_dist.phylo_df_pres_prey[[100]]) == colnames(list_dist_chisq_prey_df.ord[[100]])
```




NOW I'M READY TO COMPUTE CORRELATION



# Compute MDS


WARNING: I can't compute MDS with ~2 spp, so 1st and 2nd matrices can't be analysed. And I eliminate them from the list (6 and 7 timesteps)

```{r}

# convert to matrix


### Predators

list_dist_chisq_mat_pred <- lapply(list_dist_chisq_pred_df.ord, as.matrix)
list_dist.phylo_mat_pred <- lapply(list_dist.phylo_df_pres_pred, as.matrix)


### Preys

list_dist_chisq_mat_prey <- lapply(list_dist_chisq_prey_df.ord, as.matrix)
list_dist.phylo_mat_prey <- lapply(list_dist.phylo_df_pres_prey, as.matrix)



## Eliminate 1st and 2nd matrix - too few spp to compute MDS


list_dist_chisq_mat_pred <- list_dist_chisq_mat_pred[-c(1:3)]
list_dist_chisq_mat_prey <- list_dist_chisq_mat_prey[-c(1:3)]

list_dist.phylo_mat_pred <- list_dist.phylo_mat_pred[-c(1:3)]
list_dist.phylo_mat_prey <- list_dist.phylo_mat_prey[-c(1:3)]


length(list_dist_chisq_mat_pred) == length(list_dist.phylo_mat_pred)
length(list_dist_chisq_mat_prey) == length(list_dist.phylo_mat_prey)


# compute mds

list_mds.int_pred <- list()
list_mds.phy_pred <- list()


list_mds.int_prey <- list()
list_mds.phy_prey <- list()


# Compute MDS



for (i in 1:length(list_dist_chisq_mat_pred)) {
  
#predators
  
list_mds.int_pred[[i]] <- monoMDS(list_dist_chisq_mat_pred[[i]], 
                                  y = cmdscale(list_dist_chisq_mat_pred[[i]]))

list_mds.phy_pred[[i]] <- monoMDS(list_dist.phylo_mat_pred[[i]], 
                                  y = cmdscale(list_dist.phylo_mat_pred[[i]]))


#preys

list_mds.int_prey[[i]] <- monoMDS(list_dist_chisq_mat_prey[[i]], 
                                  y = cmdscale(list_dist_chisq_mat_prey[[i]]))

list_mds.phy_prey[[i]] <- monoMDS(list_dist.phylo_mat_prey[[i]], 
                                  y = cmdscale(list_dist.phylo_mat_prey[[i]]))
  
}


```



# Compute correlation


already have distance matrices computed (chisq, phylo)


#### Predators

```{r}


protest_pred <- list()
procrustes_pred <- list()

for (i in 1:length(list_mds.int_pred)) {
  
  protest_pred[[i]] <- protest(list_mds.int_pred[[i]], list_mds.phy_pred[[i]])
  
  procrustes_pred[[i]] <- procrustes(list_mds.int_pred[[i]],list_mds.phy_pred[[i]])
  
  
}

# I receive a warning message: 'nperm' >= set of all permutations: complete enumeratio, and Set of permutations < 'minperm'. Generating entire set.

## it starts from timestep 8

protest_pval_pred <- c()
protest_corr_pred <- c()

for (i in 1:length(protest_pred)) {
  
  protest_pval_pred[i] <- protest_pred[[i]]$signif
  
  protest_corr_pred[i] <-protest_pred[[i]]$t0

  
}

start_timeset <- length(list_simulation1$network_list) - length(protest_pred)

timesteps <- (start_timeset+1):length(list_simulation1$network_list)

df_signal_time_pred <- data.frame(timesteps,protest_pval_pred,protest_corr_pred)

df_signal_time_pred$sign <- with(df_signal_time_pred, ifelse(protest_pval_pred < 0.051, 'sign', 'non.sign'))


df_signal_time_pred

```



#### Preys

```{r}


protest_prey <- list()
procrustes_prey <- list()

for (i in 1:length(list_mds.int_prey)) {
  
  protest_prey[[i]] <- protest(list_mds.int_prey[[i]], list_mds.phy_prey[[i]])
  
  procrustes_prey[[i]] <- procrustes(list_mds.int_prey[[i]],list_mds.phy_prey[[i]])
  
  
}

# I receive a warning message: 'nperm' >= set of all permutations: complete enumeratio, and Set of permutations < 'minperm'. Generating entire set.

## it starts from timestep 8

protest_pval_prey <- c()
protest_corr_prey <- c()

for (i in 1:length(protest_prey)) {
  
  protest_pval_prey[i] <- protest_prey[[i]]$signif
  
  protest_corr_prey[i] <-protest_prey[[i]]$t0

  
}

start_timeset <- length(list_simulation1$network_list) - length(protest_prey)

timesteps <- (start_timeset+1):length(list_simulation1$network_list)

df_signal_time_prey <- data.frame(timesteps,protest_pval_prey,protest_corr_prey)

df_signal_time_prey$sign <- with(df_signal_time_prey, ifelse(protest_pval_prey < 0.051, 'sign', 'non.sign'))


df_signal_time_prey

```





### Plot phylogenetic signal through time

```{r}
library(ggplot2)

my.theme<-theme(axis.text=element_text(size=12),
                axis.title = element_text(size = 14),
                legend.position = "top",
                legend.text=element_text(size=10),
                legend.title = element_text(size=12),
                plot.title = element_text(face="bold",size=14,margin=margin(0,0,20,0),hjust = 0.5),
                axis.title.y = element_text(margin = margin(t = 0, r = 15, b = 0, l = 0)),
                axis.title.x = element_text(margin = margin(t = 15, r = 0, b = 0, l = 0)))
```


Predators

```{r}


p_pred <- ggplot(df_signal_time_pred, aes(x=timesteps, y=protest_corr_pred)) +
       geom_line()+
  geom_point(aes(fill = sign, color=sign), size=2, alpha = 0.7) +
  theme_bw()+
    my.theme+
    scale_colour_manual(values = c("black", "red"))+
    ggtitle("Phylogenetic signal through time (FOODWEB) as predators")+
xlab("timesteps")+
  ylab("Phylogenetic signal")


p_pred
```

Preys

```{r}


p_prey <- ggplot(df_signal_time_prey, aes(x=timesteps, y=protest_corr_prey)) +
       geom_line()+
  geom_point(aes(fill = sign, color=sign), size=2, alpha = 0.7) +
  theme_bw()+
    my.theme+
    scale_colour_manual(values = c("black", "red"))+
    ggtitle("Phylogenetic signal through time (FOODWEB) as preys")+
xlab("timesteps")+
  ylab("Phylogenetic signal")


p_prey
```



### Plot species richness through time


```{r}
# SHOW ALSO NUMBER OF SPECIES IN THE GRAPH

presence_matrix <- list_simulation1$presence_matrix[(start_timeset+1):length(list_simulation1$list_anc_dist),] 

n_spp_time <- c()

for (i in 1:nrow(presence_matrix)) {
  
  n_spp_time[i] <- length(which(presence_matrix[i,] == 1))
  
}

df_signal_time_pred$nspp <- n_spp_time




pred.spp <- ggplot(df_signal_time_pred, aes(x=timesteps, y = nspp)) +
  geom_line(color="black", linetype="twodash") +
  theme_bw()+
  my.theme+
  scale_colour_manual(values = c("black", "red"))+
  ggtitle("Species richness through time (FOODWEB)")+
  xlab("timesteps")+
  ylab("N species")

pred.spp

```



## COMBINED CHISQ 

Mean 

```{r}

list_mean_chisq_mat <- numeric(length(list_dist_chisq_mat_pred))

for (i in 1:length(list_dist_chisq_mat_pred)) {
  
  list_mean_chisq_mat[[i]] <- (list_dist_chisq_mat_pred[[i]] + list_dist_chisq_mat_prey[[i]])/2
  
}


dim_match_TF <- c()

for (i in 1:length(list_dist_chisq_mat_pred)) {
  
  if(dim(list_dist_chisq_mat_pred[[i]]) != dim(list_dist_chisq_mat_prey[[i]]){
    
    dim_match_TF[i] <- "FALSE"
    
    
  }else if(dim(list_dist_chisq_mat_pred[[i]]) == dim(list_dist_chisq_mat_prey[[i]]){
    
    dim_match_TF[i] <- "TRUE"
  }

  
}




n_basal.spp <- c()
n_top.pred <- c()













for (i in 1:length(list_networks_sppnames_letters)) {
  
  n_basal.spp[i] <- length(which(colSums(list_networks_sppnames_letters[[i]])==0 & 
                              rowSums(list_networks_sppnames_letters[[i]]) > 0))
  
  n_top.pred[i] <- length(which(rowSums(list_networks_sppnames_letters[[i]])==0 & 
                              colSums(list_networks_sppnames_letters[[i]]) > 0))
}

n_basal.spp

n_top.pred


which(colSums(list_networks_sppnames_letters[[173]])==0 & 
                              rowSums(list_networks_sppnames_letters[[173]]) > 0)


```










